### 微信登录

> https://developers.weixin.qq.com/ebook?action=get_post_info&docid=000cc48f96c5989b0086ddc7e56c0a

已有的互联网产品在接入小程序会面临一些和登录态相关的问题：怎么获取微信登录态；怎么把微信帐号和自己的帐号进行打通

![](https://gcy-1306312261.cos.ap-chengdu.myqcloud.com/blog/20230625153221.png)

#### 为什么不直接获取微信用户唯一 id

说到登录，我们可能很正常地想到一个做法：通过 wx.login 直接拿到微信用户的 id 编号[5]，再把这个 id 传到自己的后台，从而知道是哪个微信用户在使用我的服务。而我们上述微信登录的流程中并不是通过 wx.login 直接获取微信用户的 id，那直接获取微信用户 id 的做法有什么问题呢？

假设现在我们有个接口，通过 wx.request 请求 https://test.com/getUserInfo?id=1 拉取到微信用户 id 为 1 在我们业务侧的个人信息，那么黑客就可以通过遍历所有的 id，把整个业务侧的个人信息数据全部拉走，如果我们还有其他接口也是依赖这样的方式去实现的话，那黑客就可以伪装成任意身份来操作任意账户下的数据，想想这给业务带来多大的安全风险。

为了避免这样的风险，wx.login 是生成一个`带有时效性的凭证`，就像是一个会过期的临时身份证一样，在 wx.login 调用时，会先**在微信后台生成一张临时的身份证，其有效时间仅为 `5 分钟`**[6]。 然后把这个临时身份证返回给小程序方，这个临时的身份证我们把它称为微信登录凭证 code。如果 5 分钟内小程序的后台不拿着这个临时身份证来微信后台服务器换取微信用户 id 的话，那么这个身份证就会被作废，需要再调用 wx.login 重新生成登录凭证。

由于这个临时身份证 5 分钟后会过期，如果黑客要冒充一个用户的话，那他就必须在 5 分钟内穷举所有的身份证 id，然后去开发者服务器换取真实的用户身份。显然，黑客要付出非常大的成本才能获取到一个用户信息，同时，开发者服务器也可以通过一些技术手段检测到 5 分钟内频繁从某个 ip 发送过来的登录请求，从而拒绝掉这些请求。

开发者服务器和微信服务器通信也是通过 HTTPS 协议，微信服务器提供的接口地址是：

```shell
https://api.weixin.qq.com/sns/jscode2session?appid=<AppId>&secret=<AppSecret>&js_code=<code>&grant_type=authorization_code
```

URL 的 query 部分的参数中 <AppId>, <AppSecret>, <code> 就是前文所提到的三个信息，请求参数合法的话，接口会返回以下字段。

![](https://gcy-1306312261.cos.ap-chengdu.myqcloud.com/blog/20230625153642.png)

我们暂时只要关注前两个字段即可

`openid：` 就是前文一直提到的微信用户 id，可以用这个 id 来区分不同的微信用户。

`session_key：` 则是微信服务器**给开发者服务器颁发的身份凭证**，开发者可以用 session_key 请求微信服务器其他接口来获取一些其他信息，由此可以看到，**session_key 不应该泄露或者下发到小程序前端。**

### 获取手机号

> https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html

仅针对**企业用户开放**

```html
<button
  open-type="getPhoneNumber"
  @getphonenumber="getPhoneNumber"
  @click="jump"
>
  立即授权
</button>
```

```js
Page({
  getPhoneNumber(e) {
    console.log(e.detail.code)
  }
})
```

![](https://gcy-1306312261.cos.ap-chengdu.myqcloud.com/blog/20230625162822.png)

通过 code 获取手机号

```shell
POST https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=ACCESS_TOKEN
```

![](https://gcy-1306312261.cos.ap-chengdu.myqcloud.com/blog/20230625163020.png)

![](https://gcy-1306312261.cos.ap-chengdu.myqcloud.com/blog/20230625163043.png)

返回参数解析：

![](https://gcy-1306312261.cos.ap-chengdu.myqcloud.com/blog/20230625163106.png)
